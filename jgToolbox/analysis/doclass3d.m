function [class,classtol,rawclass] = doclass3d(file,folder,filesuppress,dispsuppress)defarg('folder',pwd);defarg('filesuppress',0);defarg('dispsuppress',0);%tol = 1.96; % .05tol = 2.58; % .01if ~exist('file','var');	[file,folder] = uigetfile('*.dat','Choose File');end% main loopif file		% get the data	data = readdata(file,folder);	period=findstr(file,'.');	if isempty(period)==0,		file=[file(1:period-1),'src.mat'];	end	cd(folder);	eval(['load ',file]);	kernal = [1 2 3 2 1];	kernal = kernal'*kernal;	% summed noise files s1r1 s1r2 s2r1 s2r2 are stored in 'src.mat' file	s1r1trials = sum(data(:,sequence)==1 & data(:,response)==1);	s1r2trials = sum(data(:,sequence)==1 & data(:,response)==2);	s2r1trials = sum(data(:,sequence)==2 & data(:,response)==1);	s2r2trials = sum(data(:,sequence)==2 & data(:,response)==2);	fprintf(1,['Total trials = ',num2str(size(data,1)),'.\n']);		% divide by # of trials	s1r1 = s1r1/s1r1trials;	s1r2 = s1r2/s1r2trials;	s2r1 = s2r1/s2r1trials;	s2r2 = s2r2/s2r2trials;		% smoothed image	rawclass = s1r2-s1r1+s2r2-s2r1;	nframes = size(rawclass,3);	for i = 1:nframes		class(:,:,i) = conv2(rawclass(:,:,i),kernal,'same');	end		% statistical image	classtol = class;	squarekernal = sqrt(sum(sum(kernal.^2)));	s1r1var = noisevar*nframes/s1r1trials;	s1r2var = noisevar*nframes/s1r2trials;	s2r1var = noisevar*nframes/s2r1trials;	s2r2var = noisevar*nframes/s2r2trials;	classvar = s1r1var + s1r2var + s2r1var + s2r2var;	smoothstd = squarekernal*sqrt(classvar);	classmaxval = tol*smoothstd;			%classmaxval = tol*std(classtol(:));			tollocs = find(abs(classtol)<classmaxval);	postollocs = find(classtol>classmaxval);	negtollocs = find(classtol<-classmaxval);	classtol(tollocs) = .5;	classtol(postollocs) = 1;	classtol(negtollocs) = 0;		% scale	numstd = 6; 	classmean = mean(class(:)); 	classstd = std(class(:)); 	class = (class-classmean)./(numstd*classstd) + .5; 		class(find(class > 1)) = 1;	class(find(class < 0)) = 0;% 	classmean = mean(class(:));% 	class = scale(class-classmean + .5);			% display	class = scalearbND(class,0,1);	classtol = scalearbND(classtol,0,1);	if ~dispsuppress		figure; imshowmovie(class);		figure; imshowmovie(classtol);		drawnow;	end	if ~filesuppress			% write to file		period=findstr(file,'.');		file=file(1:period-4);		[newfile,newfolder] = uiputfile([file,'class.mat'],'Save File As');			if newfile					save([newfolder,newfile],'class','classtol');		end	end	end