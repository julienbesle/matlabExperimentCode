function [void] = docal(Device, Sc_Height, Sc_Width, Spot_Size, Spot, numsamples)% calibration routine% April 4, 1997.  JMG ABS  U of Toronto Vision Lab.%% Depedencies: savedatetime, savecomment, savecommand, dofit%			   SCREEN, hidecursor, showcursor, CenterRect (psych toolbox)%% Fixed for MATLAB 5.1  JMG   January 30, 1998% July 1998 JMG: included final fitting routineSamples = round(linspace(1,254,numsamples));Data = zeros(length(Samples),3);[Data_File, Data_Folder] = uiputfile('Data.params','Save Data As');Main_Folder = pwd;hidecursor;[windowPtr,Sc_Size] = screen(Device,'OpenWindow',160);Spot = CenterRect(Spot,Sc_Size);screen(windowPtr,'SetClut',[160 160 160],0);SCREEN(windowPtr,'FillRect',0);[oldFontName,oldFontNumber]=SCREEN(windowPtr,'TextFont',20);oldFontSize=SCREEN(windowPtr,'TextSize',16);oldStyle=SCREEN(windowPtr,'TextStyle',2);done = 0;for Gun = 1:3	RGB = [0 0 0];	for Pixel = 1:length(Samples)		RGB(Gun) = Samples(Pixel);		screen(windowPtr,'SetClut',RGB,1);		SCREEN(windowPtr,'FillRect',0);		screen(windowPtr,'FillOval',1,Spot);		text = ['R = ',num2str(RGB(1)),', G = ',num2str(RGB(2)),', B = ',num2str(RGB(3))];		[newX,newY] = SCREEN(windowPtr,'DrawText',text,10,20,2);		screen(windowPtr,'DrawText','Hit ESC To Quit At Any Time.',10,Sc_Height-10,2);		Lum = ' ';		loc = 1;		entered = 0;		while entered ~= 1							screen(windowPtr,'DrawText',['Enter Luminance (cd/m^2) then hit <RETURN>:  ',Lum],190,20,2);			Lum(loc) = getchar;			if ( (abs(Lum(loc)) == abs('.')) | (abs(Lum(loc)) == abs('-')) |  (abs(Lum(loc)) == abs('+')) | (abs(Lum(loc)) == abs('e')) | ( (abs(Lum(loc)) >= abs('0')) & (abs(Lum(loc)) <= abs('9'))) ) 				loc = loc + 1;			elseif abs(Lum(loc)) == 13 & loc > 1				entered = 1;			elseif abs(Lum(loc)) == 27				done = 1;				break;				elseif abs(Lum(loc)) == 8				if loc > 1					loc = loc - 1;				end				screen(windowPtr,'DrawText',['Enter Luminance (cd/m^2) then hit <RETURN>:  ',Lum],190,20,0);				Lum(loc) = ' ';				screen(windowPtr,'DrawText',['Enter Luminance (cd/m^2) then hit <RETURN>:  ',Lum],190,20,2);			else				Lum(loc) = ' ';			end			end		if done == 1			break;		end		Lum = str2num(Lum);				Data(Pixel,Gun) = Lum;	end	if done == 1		break;	endend screen(windowPtr,'Close');showcursor;% Output of data file is in the format "GRB" not "RGB". Switch these.Data = [Data(:,2),Data(:,1),Data(:,3)];% Write the data out to the data file.fwid = fopen([Data_Folder,Data_File],'w+');savedatetime(fwid);savecomment(fwid,'BACKGROUND = 160'); savecomment(fwid,['SPOT DIAMETER = ',num2str(Spot_Size)]); savecommand(fwid,'pval = 1; gval = 2; rval = 3; bval = 4;');for i = 1:length(Samples)	fprintf(fwid,'%g\t',Samples(i),Data(i,:));	fprintf(fwid,'\n');endfclose(fwid);period=findstr(Data_File,'.');if isempty(period)==0,	newname=[Data_File(1:period),'DDF'];else	newname=[Data_File,'.DDF'];enddofit(Data_File,Data_Folder,newname);return