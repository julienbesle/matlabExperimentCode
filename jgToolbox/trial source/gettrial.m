function [ newsrc, level, id ] = gettrial( trialsrc )% GETTRIAL  Poll a trial source.%% [ newsrc, level, id ] = gettrial( trialsrc )% 28-Jan-98 -- created (RFM)switch lower(trialsrc.type)	case 'constim',		id=trialsrc.id;		if trialsrc.round>trialsrc.nmax,			level=NaN;		else			trialsrc.trial=trialsrc.trial+1;			level=trialsrc.levels(trialsrc.perm(trialsrc.iperm));			trialsrc.iperm=trialsrc.iperm+1;			if trialsrc.iperm>trialsrc.nlevels,				trialsrc.iperm=1;				trialsrc.perm=randperm(trialsrc.nlevels);				trialsrc.round=trialsrc.round+1;			end		end		case 'quest',		id=trialsrc.id;		if ~isnan(trialsrc.final),			level=NaN;		else			trialsrc.trial=trialsrc.trial+1;			[ maxprob maxi ] = max(trialsrc.pdf);			level=trialsrc.levels(maxi);		end		case 'pquest',		id=trialsrc.id;		if ~isnan(trialsrc.final),			level=NaN;		else			trialsrc.trial=trialsrc.trial+1;			level=10^questmean(trialsrc.q);		end		case 'udtr',		id=trialsrc.id;		trialsrc.trial=trialsrc.trial+1;		level=trialsrc.levels(trialsrc.leveli);		case 'series',		id=trialsrc.id;		if trialsrc.leveli>trialsrc.nlevels,			level=NaN;		else			level=trialsrc.levels(trialsrc.leveli);			trialsrc.trial=trialsrc.trial+1;			trialsrc.levtrial=trialsrc.levtrial+1;			if trialsrc.levtrial>=trialsrc.levmax,				trialsrc.levtrial=0;				trialsrc.leveli=trialsrc.leveli+1;			end		end	% trial sources are polled with round-robin queue discipline	case 'list',		done=0;		while done==0,			isource=trialsrc.perm(trialsrc.iperm);			[ trialsrc.sources{isource}, level, id ] = ...				gettrial( trialsrc.sources{isource} );			if isnan( level ),				trialsrc.active(isource)=0;				if isempty( find(trialsrc.active) )==1,					id=NaN;					break				end			else				trialsrc.trial=trialsrc.trial+1;				trialsrc.prevsource=isource;				done=1;			end			trialsrc.iperm=trialsrc.iperm+1;			if trialsrc.iperm>size(trialsrc.perm,2),				trialsrc.iperm=1;				active=find(trialsrc.active);				trialsrc.perm=active(randperm(size(active,2)));			end		end		otherwise		error(sprintf('Unknown trial source type ''%s''.',trialsrc.type));	endnewsrc=trialsrc;return