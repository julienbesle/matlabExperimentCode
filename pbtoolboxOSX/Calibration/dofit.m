function dofit(file,folder,newfile)% fits parameters to calibration data and makes a % calibration file.%% Adapted from bennett's BigCal.igor.%% Depedencies: readdata, pellifit, loadlum, pellipower, findstr%  			   savedatetime, savecomment, savecommand%% July 1998 JMG U of T Vision Labif file	if ~exist('folder','var')		folder = pwd;	else		cd(folder);	end		data = readdata(file,folder);		% initial parameters	numpts = 255;	alpha = min(min(data(:,1:3)));	beta = .01;	kappa = .01;	gamma = 2;	initcoeffs = [alpha beta kappa gamma];	% fits	coeffs(1,:) = pellifit(data(:,pval),data(:,rval),initcoeffs);	coeffs(2,:) = pellifit(data(:,pval),data(:,gval),initcoeffs);	coeffs(3,:) = pellifit(data(:,pval),data(:,bval),initcoeffs);	bigdata = loadlum(coeffs,numpts);	coeffs(4,:) = pellifit([1:length(bigdata(:,end))]',bigdata(:,end),initcoeffs);	% red gun plot	fitindex=[1:.1:numpts];	fithandle = figure('NumberTitle','off','Name','Calibration Results');	subplot(2,2,1); 	rfit = pellipower(coeffs(1,:),fitindex);	plot(data(:,pval),data(:,rval),'ro');hold on;	plot(fitindex,rfit,'k-');	ylabel('Luminance (cd/m^2)');	xlabel('Pixel Value');	title('Red Gun');			% green gun plot	subplot(2,2,2); 	gfit = pellipower(coeffs(2,:),fitindex);	plot(data(:,pval),data(:,gval),'go'); hold on;	plot(fitindex,gfit,'k-');	ylabel('Luminance (cd/m^2)');	xlabel('Pixel Value');	title('Green Gun');		% blue gun plot	subplot(2,2,3); 	bfit = pellipower(coeffs(3,:),fitindex);	plot(data(:,pval),data(:,bval),'bo'); hold on;	plot(fitindex,bfit,'k-');	ylabel('Luminance (cd/m^2)');	xlabel('Pixel Value');	title('Blue Gun');			% final calibration plot	subplot(2,2,4); 	plot([1:length(bigdata(:,end))],bigdata(:,end),'k-');	ylabel('Luminance (cd/m^2)');	xlabel('Index');	title('Look-Up Table');				drawnow;		% save the calibration file	if ~exist('newfile','var')		period=findstr(file,'.');		if isempty(period)==0,			newname=[file(1:period),'DDF'];		else			newname=[file,'.DDF'];		end		[newfile,newfolder] = uiputfile(newname,'Save File As');	else		newfolder = folder;	end	if newfile		fwid = fopen([newfolder,newfile],'w+');		savecomment(fwid,'L(v)/cdm^2 = a + (b + kv)^g  {if b + kv >= 0}');		savecomment(fwid,'			   a				 {otherwise}');		savedatetime(fwid);		savecommand(fwid,['rcoeffs = [',num2str(coeffs(1,1)),',',num2str(coeffs(1,2)),',',num2str(coeffs(1,3)),',',num2str(coeffs(1,4)),'];']);		savecommand(fwid,['gcoeffs = [',num2str(coeffs(2,1)),',',num2str(coeffs(2,2)),',',num2str(coeffs(2,3)),',',num2str(coeffs(1,4)),'];']);		savecommand(fwid,['bcoeffs = [',num2str(coeffs(3,1)),',',num2str(coeffs(3,2)),',',num2str(coeffs(3,3)),',',num2str(coeffs(3,4)),'];']);		savecommand(fwid,['coeffs = [',num2str(coeffs(end,1)),',',num2str(coeffs(end,2)),',',num2str(coeffs(end,3)),',',num2str(coeffs(end,4)),'];']);		savecommand(fwid,'r = 1; g = 2; b = 3; lum = 4;');		for i = 1:size(bigdata,1)			fprintf(fwid,'%g\t',bigdata(i,:));			fprintf(fwid,'\n');		end		fclose(fwid);		cd(newfolder);		eval(['edit ',newfile]);			end	end