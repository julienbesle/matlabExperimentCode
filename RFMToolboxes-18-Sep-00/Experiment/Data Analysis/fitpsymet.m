function [ theta1, theta2 ] = fitpsymet( data, dist, init, gamma, delta )% fitpsymet - find maximum-likelihood psychometric function%% [ theta1, theta2 ] = fitpsymet( data, dist, init, gamma, delta )% late 96 -- created (RFM)%set default argumentsdefarg('dist','weibull');defarg('init','');defarg('gamma',0.5);defarg('delta',0.01);% check fit typeif ~(strcmp(dist,'norm') || strcmp(dist,'weibull') ),	error(sprintf('Unknown fit type ''%s''',dist));end% set default initialization if necessaryif isempty(init),	init = [ mean(data(:,1)), ifso(strcmp(dist,'norm'),std(data(:,1)),2) ];%(A)end% set options for minimization% opt=foptions;% opt(2)=0.0001;   % parameter tolerance% opt(3)=0.000001; % error tolerance% opt(14)=1000;    % maximum number of iterations% changed from foptions to optimset, ZH 2010opt=optimset('Display','off', 'TolX',0.0001,'TolFun',0.000001, 'MaxFunEvals',1000);% raw trials?if size(data,2)==2,	if isempty(find(data(:,2)==0, 1)),		warning('All trials were correct');		theta1=NaN;		theta2=NaN;    else %        fiterr(x,trials)%         %         inline( sprintf( [ ...% 			'-sum(log( %f+%f*%scdf( trials(find(trials(:,2)==1),1), x(1), x(2) ) ))' ...% 			'-sum(log( %f-%f*%scdf( trials(find(trials(:,2)==0),1), x(1), x(2) ) ))' ], ...% 			gamma,1-(gamma+delta),dist,(1-gamma),1-(gamma+delta),dist ), ...% 			'x', 'trials' );% 		fit=fmins(fiterr,init,opt,[],data); 		        [fit, fval]=fminsearch(@fiterr, init, opt); % replaced fmins with fminsearch and modified above inline function at lines 72-75 ZH, 2010        theta1=fit(1);  		theta2=fit(2);    end% commented out empirical stuff below as not needed for current data format, ZH 2010    % % empirical psychometric function from 'emppsymet.m'?% elseif size(data,2)==4,% 	levels=data(:,1);% 	ntrials=data(:,3);% 	ncorrect=round(data(:,2).*data(:,3));% 	fiterr = inline( sprintf( ...% 		'-sum(log( binopdf(ncorrect,ntrials,%f+%f*%scdf(levels,x(1),x(2))) ))', ...% 		gamma,1-(gamma+delta),dist ), 'x', 'levels', 'ntrials', 'ncorrect' );% 	fit=fmins(fiterr,init,opt,[],levels,ntrials,ncorrect);% 	theta1=fit(1);% 	theta2=fit(2);% 	% else% 	error('Invalid parameter <data>');endfunction [f] = fiterr(x)         trials = data;        f = -sum(log( 0.500000+0.400000*weibullcdf( trials(trials(:,2)==1,1), x(1), x(2) ) ))-sum(log( 0.500000-0.400000*weibullcdf( trials(trials(:,2)==0,1), x(1), x(2) ) ));endreturnend% why?% Initial(2)=log(Initial(2));  % before fitting% theta2=exp(fit(2));          % after fitting%(A)%	init = [ -log(0.1)/max(trials(:,1))^2 2 ]; % for weibull